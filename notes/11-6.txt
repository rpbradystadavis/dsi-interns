finalize the functions.

I tried to write the big function to many unit functions.


